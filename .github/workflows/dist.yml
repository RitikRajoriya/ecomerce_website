name: Deploy Admin Frontend Dist

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸš€ Deploy admin dist to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            set -e

            # ================= CONFIG =================
            WORK_DIR="/home/ubuntu/ecomerce_website"
            TARGET_DIR="/var/www/craftshop/dist"
            ZIP_PATTERN="dist*.zip"
            OWNER="www-data"
            GROUP="www-data"
            # ==========================================

            echo "ğŸ“ Moving to dist repository"
            cd "$WORK_DIR"

            echo "ğŸ“¥ Pulling latest code"
            git pull origin main

            echo "ğŸ” Checking unzip availability"
            if ! command -v unzip >/dev/null 2>&1; then
              echo "ğŸ“¦ unzip not found, installing..."
              sudo apt update
              sudo apt install unzip -y
            fi

            echo "ğŸ“¦ Locating latest dist zip"
            ZIP_FILE=$(ls -t $ZIP_PATTERN 2>/dev/null | head -n 1)

            if [ -z "$ZIP_FILE" ]; then
              echo "âŒ No dist zip found"
              exit 1
            fi

            echo "âœ… Using zip: $ZIP_FILE"

            echo "ğŸ§¹ Cleaning old admin frontend files"
            sudo rm -rf "$TARGET_DIR"/*

            echo "ğŸ“¦ Extracting dist"
            sudo unzip -o "$ZIP_FILE" -d "$TARGET_DIR"

            echo "ğŸ‘¤ Setting ownership"
            sudo chown -R "$OWNER":"$GROUP" "$TARGET_DIR"

            echo "ğŸ” Setting permissions"
            sudo find "$TARGET_DIR" -type d -exec chmod 775 {} \;
            sudo find "$TARGET_DIR" -type f -exec chmod 775 {} \;

            echo "ğŸ‰ Admin frontend deployed successfully"
